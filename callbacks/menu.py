from utils.telegram import send_message
from db.slots import play_slots
from utils.config import PRICE_SH, TON_WALLET, ADMIN_ID, TELEGRAM_API_URL
import requests

async def menu_callback(callback):
    user_id = callback["from"]["id"]
    data = callback["data"]
    callback_id = callback["id"]
    
    # ????? ????? ????? ???? ????? (Toast)
    def notify(text):
        requests.post(f"{TELEGRAM_API_URL}/answerCallbackQuery", json={
            "callback_query_id": callback_id,
            "text": text,
            "show_alert": False
        })

    if data == "menu_slots":
        notify("?? ?????? ????? ??????...")
        await play_slots(user_id)
        
    elif data == "menu_buy":
        notify("?? ???? ???? ?????...")
        msg = f"? **???? ?????** ?\n\n????: {PRICE_SH}\n????? (TON):\n{TON_WALLET}\n\n??? ??? ????? ??? ?? ?????? ????."
        send_message(user_id, msg, {"inline_keyboard": [[{"text": "? ????? - ??? ?????", "callback_data": "req_approve"}]]})

    elif data == "req_approve":
        notify("?? ???? ?????!")
        admin_msg = f"?? **????? ???? ??????!**\nID: {user_id}\n??: {callback['from'].get('first_name')}"
        send_message(ADMIN_ID, admin_msg, {"inline_keyboard": [[{"text": "? ??? ????", "callback_data": f"approve_{user_id}"}]]})
        send_message(user_id, "? ????? ???? ?? ?????. ??? ???? ?????.")

    elif data.startswith("approve_"):
        uid = data.split("_")[1]
        notify("? ????!")
        send_message(uid, "?? **??? ???! ????? ??? ????? ?????!**\n??? /start ??? ?????? ?????.")
        send_message(ADMIN_ID, f"????! ????? {uid} ????? ?????.")
