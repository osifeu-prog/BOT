<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Diamond Pro Arcade</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; overflow: hidden; }
        .game-header { background: #111; padding: 15px; border-bottom: 2px solid #bf953f; display: flex; justify-content: space-between; }
        #gameCanvas { background: linear-gradient(to bottom, #1e3c72, #2a5298); display: block; width: 100%; height: 350px; }
        .controls { position: absolute; bottom: 20px; width: 100%; text-align: center; }
        .jump-btn { width: 80px; height: 80px; background: rgba(255,255,255,0.2); border: 3px solid #fff; border-radius: 50%; color: #fff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="game-header">
        <div> <span id="balance">注...</span></div>
        <div style="color: #bf953f; font-weight: bold;">LEVEL 1</div>
    </div>
    
    <canvas id="gameCanvas"></canvas>

    <div class="controls">
        <button class="jump-btn" id="jumpBtn">JUMP</button>
        <p>爪专 拽转 专转 SLH</p>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let canvas = document.getElementById('gameCanvas');
        let ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = 350;

        let score = 0;
        let player = { x: 50, y: 280, w: 40, h: 40, dy: 0, jumping: false };
        let obstacles = [];

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw Player (专 砖专)
            ctx.fillStyle = "#ffcc00";
            ctx.shadowBlur = 15;
            ctx.shadowColor = "#ffcc00";
            ctx.fillRect(player.x, player.y, player.w, player.h);
            ctx.shadowBlur = 0;

            // Physics
            if (player.jumping) {
                player.dy += 0.8;
                player.y += player.dy;
                if (player.y > 280) {
                    player.y = 280;
                    player.jumping = false;
                }
            }

            // Obstacles
            if (Math.random() < 0.01) obstacles.push({ x: canvas.width, y: 290, w: 30, h: 30 });
            obstacles.forEach((o, i) => {
                o.x -= 5;
                ctx.fillStyle = "#ff4444";
                ctx.fillRect(o.x, o.y, o.w, o.h);
                
                // Collision
                if (player.x < o.x + o.w && player.x + player.w > o.x && player.y < o.y + o.h && player.y + player.h > o.y) {
                    gameOver();
                }
            });

            score++;
            requestAnimationFrame(draw);
        }

        async function gameOver() {
            tg.HapticFeedback.notificationOccurred('error');
            let reward = Math.floor(score / 10);
            alert("砖拽 专! 爪专转 " + reward + " SLH");
            await fetch('/api/game-action?user_id=' + tg.initDataUnsafe.user.id + '&action=mario&amount=' + reward, {method: 'POST'});
            location.reload();
        }

        document.getElementById('jumpBtn').addEventListener('touchstart', () => {
            if (!player.jumping) {
                player.dy = -15;
                player.jumping = true;
                tg.HapticFeedback.impactOccurred('light');
            }
        });

        draw();
        tg.expand();
    </script>
</body>
</html>
